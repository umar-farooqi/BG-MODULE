WITH REMAINING_AMOUNT AS (  
    SELECT 
        AFL.ID,
        AFL.ACCOUNT_NO AS ACCOUNT_NO,
        NVL(AFL.AMOUNT, 0) AS AMOUNT,
        NVL(AFL.REMAINING, 0) REMAINING
    FROM AB_FACILITIES_LETTER AFL  
    WHERE AFL.FACILITIES_TYPE = 'LIMIT UTILIZATION'
    AND AFL.ORG_ID = :GV_ORG_ID
),

FACILITY_DATA AS (
    SELECT  
        MAX(AFL.FACILITIES_ID) AS FACILITIES_ID,
        AFL.ACCOUNT_NO,
        SUM(DISTINCT NVL(AFLD.AMOUNT, 0)) AS FACILITY_AMOUNT,
        SUM(NVL(TO_NUMBER(REMM.AMOUNT), 0)) AS LIMIT_UTILIZATION
    FROM AB_FACILITIES_LETTER AFL
    LEFT JOIN AB_FACILITIES_LETTER_DET AFLD ON AFLD.MAST_ID = AFL.ID
    LEFT JOIN AB_FACILITIES_LETTER_DET AFLDS ON AFLDS.IDS = AFLD.ID
    LEFT JOIN REMAINING_AMOUNT REMM ON REMM.ACCOUNT_NO = AFLDS.ID
    WHERE 
        AFLD.FACILITIES_TYPE = 'FACILITIES DET'
        AND BANK_ID = :P385_BANK_ID
        AND AFLD.FACILITIES_ID = :P385_FACILITIES_ID
        AND AFLDS.ORG_ID = :GV_ORG_ID  
    GROUP BY  AFL.ACCOUNT_NO  -- ✅ Fixed grouping
)

SELECT 
    
    SUM(FACILITY_AMOUNT) AS FACILITY_AMOUNT,  -- ✅ Corrected sum
    SUM(LIMIT_UTILIZATION) AS LIMIT_UTILIZATION,
    SUM(FACILITY_AMOUNT) - SUM(LIMIT_UTILIZATION) AS REMAINING,
    MAX(FACILITIES_ID),
    ACCOUNT_NO
FROM FACILITY_DATA
GROUP BY FACILITIES_ID, ACCOUNT_NO -- ✅ Fixed grouping to avoid duplication
ORDER BY ACCOUNT_NO;
