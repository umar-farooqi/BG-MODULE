select AFL.ID,
       AFL.MAST_ID,
       AFL.FACILITIES_ID,
    MAX(CASE 
        WHEN ALD.DET_ID = AFL.FACILITIES_ID AND LOOKUP_ID = 032 
        THEN ALD.LOOKUP_DET_NAME 
        ELSE NULL 
    END) AS FACILITIES_NAME,
    MAX(
        CASE WHEN ALD.DET_ID = AFL.NATURE_ID AND LOOKUP_ID  = 030 
        THEN ALD.LOOKUP_DET_NAME 
        ELSE NULL
        END) AS NATURE_NAME,
       AFL.NATURE_ID,
       AFL.AMOUNT,
       AFL.CASH_MARGIN,
       AFL.ISSUE_DATE,
       AFL.EXP_DATE,
       AFL.SERVICE_CHARGES,
       AFL.BG_SECURITY,
       AFL.ACCOUNT_NO,
       AFL.COLLATERAL,
       AFL.BG_CHARGES,
       AFLS.IDS,
    LISTAGG(DISTINCT CASE WHEN AFLS.IDS = AFL.ID  THEN AFLS.COMPANY_NAME END, ', ') WITHIN GROUP (ORDER BY AFLS.IDS) AS EMP_NAMES,

    LISTAGG(DISTINCT CASE WHEN AFLS.COMPANY_NAME = ASR.SR_ID AND AFLS.IMAGE_TYPE = 'FACILITIES COMPANY' THEN ASR.REG_NAME END, ': ')  WITHIN GROUP (ORDER BY AFLS.IDS) AS COMPANY_NAMES,

    LISTAGG(DISTINCT CASE WHEN AFLS.IDS = AFL.ID  THEN AFLS.INTITLED_COMPANY END, ', ')  WITHIN GROUP (ORDER BY AFLS.IDS) AS INTITLED_COMPANY,
    
    LISTAGG(DISTINCT CASE WHEN AFLS.INTITLED_COMPANY = ASR.SR_ID  THEN ASR.PARTY_NAME  END, ': ') 
        WITHIN GROUP (ORDER BY AFLS.IDS) AS INTITLED_COMPANYS,

      -- MAX(CASE WHEN ASR.SR_ID = AFLS.COMPANY_NAME AND REG_TYPE = 'COMPANY' THEN ASR.REG_NAME ELSE NULL END ) AS COMPANY_NAMES,     
       'SHOW IMAGE' AS ATTACHMENT,
       CASE  WHEN TRUNC(SYSDATE) < AFL.EXP_DATE THEN 'Y'
       WHEN  TRUNC(SYSDATE) > AFL.EXP_DATE THEN 'EXPIRE' ELSE 'Y' END AS STATUS 



 from AB_FACILITIES_LETTER_DET AFL
 join AB_FACILITIES_LETTER_DET AFLS ON AFLS.IDS = AFL.ID
 left JOIN AB_SETUP_REGISTRATION ASR ON ASR.SR_ID IN (AFLS.COMPANY_NAME, AFLS.INTITLED_COMPANY)

  left JOIN AB_LOOKUP_DETAIL ALD ON ALD.DET_ID IN ( AFL.FACILITIES_ID, AFL.NATURE_ID) 
  
  WHERE AFL.ORG_ID = :GV_ORG_ID
  AND   AFL.MAST_ID = :P370_DET_ID
  GROUP BY 
       AFL.INTITLED_COMPANY,
       AFL.NATURE_ID,
       AFL.AMOUNT,
       AFL.CASH_MARGIN,
       AFL.ISSUE_DATE,
       AFL.IDS,
           AFLS.IDS,
       AFL.EXP_DATE,       AFL.STATUS,
       AFL.SERVICE_CHARGES,
       AFL.BG_SECURITY,
       AFL.ACCOUNT_NO,
       AFL.COLLATERAL,
       AFL.BG_CHARGES,
       AFL.COMPANY_NAME,
       AFL.ID,
       AFL.MAST_ID,
       AFL.FACILITIES_ID



