WITH APPROVE_AMOUNT AS(
   SELECT    POR.IDS,
            POR.BANK_ID,
            AST.REG_NAME||' - '|| ASM.REG_CODE  AS BANK,
             SUM(APP_BALANCE) APP_BAL
     FROM    AB_PO_DEMAND_REQ_DET POR
     JOIN 
    AB_SETUP_REGISTRATION ASM ON ASM.SR_ID= POR.BANK_ID
JOIN 
    AB_SETUP_REGISTRATION AST 
    ON AST.SR_ID = ASM.SR_IDS AND AST.REG_TYPE = 'BANK'
WHERE 
    ASM.REG_TYPE = 'BANK LOV'
    AND    POR.ORG_ID=:GV_ORG_ID
      AND    POR.DET_STATUS IS NOT NULL
      AND    POR.STATUS='Y'
     AND     POR.DET_STATUS='ALLOCATED'
      AND    POR.APP_BALANCE > 0
 GROUP BY
           POR.IDS, 
           POR.BANK_ID,
           AST.REG_NAME,
           ASM.REG_CODE
)
 SELECT    
            -- DRD.DET_ID,
--            DRD.ITEM_ID,
--            ITM.ITEM_NAME PRODUCT,
--            LD.LOOKUP_DET_NAME NATURE_OF_FUND,
--            USR.UM_NAME AS DEPARTMENT,
           APM.BANK,
        --    DRD.REMARKS,
        --    DRD.PARTY_ID,
        --    CASE
        --         WHEN ASR.REG_TYPE IN ('AGENCY','CUSTOMER REGISTRATION')THEN  ASR.REG_NAME
        --         ELSE ASR.PARTY_NAME
        --    END AS PARTY_NAME,
        --    DRD.BUYING_DATE,
        --    DRD.DUE_DATE,
        --    TO_CHAR(DRD.BALANCE, '999G999G999G999G990D00') AS REQUISTION_AMOUNT,
           TO_CHAR(NVL(APM.APP_BAL, 0), '999G999G999G999G990D00') AS APPROVE_AMOUNT,
        --    CASE 
        --         WHEN DRD.BALANCE - NVL(APM.APP_BAL, 0) > 0 THEN
        --             TO_CHAR(DRD.BALANCE - NVL(APM.APP_BAL, 0), '999G999G999G999G990D00')
        --         ELSE 
        --             TO_CHAR(DRD.BALANCE - NVL(APM.APP_BAL, 0), '999G999G999G999G990D00')
        --     END BALANCE_AMOUNT,
        CASE 
                WHEN APM.APP_BAL IS NULL 
                    THEN 'Created'
                WHEN DRD.BALANCE > NVL(APM.APP_BAL,0)  
                    THEN 'Partial Allocated'
                WHEN DRD.BALANCE = APM.APP_BAL 
                    THEN 'Allocated'
            ELSE NULL 
        END AS DEMAND_STATUS--, 
    
          -- INITCAP(DRD.CREATED_BY ||' ('|| TO_CHAR(DRD.CREATED_ON,'DD-MON-YYYY') ||')') AS  CREATED_BY--,
          -- 'APPROVE' APPROVE
     from  AB_PO_DEMAND_REQ_DET DRD
LEFT JOIN  AB_SETUP_REGISTRATION ASR ON ASR.SR_ID=DRD.PARTY_ID
LEFT JOIN  AB_ITEMS_MASTER ITM ON ITM.ITEM_ID=DRD.ITEM_ID
LEFT JOIN  APPROVE_AMOUNT APM ON APM.IDS=DRD.DET_ID
LEFT JOIN  AB_LOOKUP_DETAIL LD ON LD.DET_ID = DRD.LOOKUP_ID AND LD.STATUS ='Y' AND LD.LOOKUP_ID='030'
 LEFT JOIN AB_UM_SETUP_REGISTRATION USR ON USR.UM_ID  = DRD.DEPARTMENT_ID AND USR.STATUS = 'Y'
    WHERE  DRD.ORG_ID=:GV_ORG_ID
      AND  DRD.DET_STATUS IS NOT NULL
      AND  DET_STATUS='CREATED'
      and  DRD.BALANCE = APM.APP_BAL 

    
ORDER BY   DRD.CREATED_ON DESC
