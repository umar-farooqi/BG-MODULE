WITH FACILITY_LETTER AS (
    SELECT 
        AFL.BANK_NAME, 
        AFL.FACILITIES_ID,
        NVL(SUM(AFLD.AMOUNT), 0) AS AMOUNT,
        NVL(SUM(SUM(AFLD.AMOUNT)) OVER (), 0) AS TOTAL_SUM
  
    FROM 
        AB_FACILITIES_LETTER AFL
    LEFT JOIN 
        AB_FACILITIES_LETTER_DET AFLD 
    ON 
        AFLD.MAST_ID = AFL.ID
    WHERE 
        AFL.FACILITIES_TYPE = 'FACILITIES MAST'
        AND AFL.ORG_ID = NVL(:GV_ORG_ID,AFL.ORG_ID)
    GROUP BY 
        AFL.BANK_NAME,AFL.FACILITIES_ID,
),
UTILIZATION AS (
    SELECT
        AFL.BANK_NAME,
        NVL(SUM(AFL.AMOUNT), 0) AS AVAILED,
        NVL(SUM(SUM(AFL.AMOUNT))OVER (), 0) AS AMOUNT_AVAILED
    FROM AB_FACILITIES_LETTER AFL
    LEFT JOIN AB_FACILITIES_LETTER_DET AFLD ON AFLD.MAST_ID = AFL.ID
    WHERE AFL.FACILITIES_TYPE = 'LIMIT UTILIZATION'
    AND AFL.ORG_ID = NVL(:GV_ORG_ID, AFL.ORG_ID)
    GROUP BY 
        AFL.BANK_NAME
)
SELECT 
   FL.BANK_NAME,
    FL.AMOUNT, 
    FL.TOTAL_SUM,
    UT.AVAILED, 
    UT.AMOUNT_AVAILED,
      NVL(FL.AMOUNT, 0) - NVL(UT.AVAILED, 0) AS BALANCE
      
FROM 
    FACILITY_LETTER FL
LEFT JOIN 
    UTILIZATION UT 
ON 
    UT.BANK_NAME = FL.BANK_NAME

