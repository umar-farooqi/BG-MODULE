  WITH REMAINING_AMOUNT AS (  SELECT 
    AFL.ID,
    AFL.ACCOUNT_NO AS ACCOUNT_NO,
    NVL(AFL.AMOUNT, 0) AS AMOUNT,
    NVL(AFL.REMAINING,0) REMAINING
FROM AB_FACILITIES_LETTER AFL  
WHERE AFL.FACILITIES_TYPE = 'LIMIT UTILIZATION'
AND AFL.ORG_ID = :GV_ORG_ID
--GROUP BY AFL.ID, AFL.ACCOUNT_NO, AFL.REMAINING
  )
  
    SELECT
                FACILITY_AMOUNT,
                NVL(SUM(LIMIT_UTILIZATION),0) LIMIT_UTILIZATION,
                NVL(FACILITY_AMOUNT,0) -  NVL(SUM(LIMIT_UTILIZATION),0)  REMAINING
               -- NVL(sum(REMAINING),0)REMAINING 
    FROM(
    SELECT  
          NVL(AFLD.AMOUNT,0) AS FACILITY_AMOUNT,
           NVL(TO_NUMBER(REMM.AMOUNT), 0) LIMIT_UTILIZATION,
           NVL(AFLD.AMOUNT,0) - NVL(TO_NUMBER(REMM.AMOUNT), 0) REMAINING
    
    FROM 
           AB_FACILITIES_LETTER  AFL
      LEFT JOIN AB_FACILITIES_LETTER_DET AFLD ON AFLD.MAST_ID = AFL.ID
      LEFT JOIN AB_FACILITIES_LETTER_DET AFLDS ON AFLDS.IDS = AFLD.ID
      LEFT JOIN REMAINING_AMOUNT   REMM ON REMM.ACCOUNT_NO = AFLDS.ID
      --LEFT JOIN ACCOUNT_NUMBER_DETAIL ACC ON  AFLDS.ID = AFLD.ID

   WHERE 
       AFLD.FACILITIES_TYPE = 'FACILITIES DET'
    AND    AFLDS.ID  =    :P385_ACCOUNT_NO
      AND  AFLDS.ORG_ID = :GV_ORG_ID  
      GROUP BY 
    NVL(AFLD.AMOUNT,0),
   NVL(TO_NUMBER(REMM.AMOUNT), 0))
   GROUP BY
                FACILITY_AMOUNT

=====================================
-- NEW QUERY ACCOUNT_NO ITEM 

WITH REMAINING_BALANCE AS (
   SELECT           
       NVL(SUM(AFL.AMOUNT), 0) AS AMOUNT,
       AFL.ACCOUNT_NO AS ACCOUNT_NO
   FROM 
       AB_FACILITIES_LETTER AFL
   WHERE
       AFL.ORG_ID = :GV_ORG_ID
       AND AFL.STATUS = 'Y'
       AND AFL.ACCOUNT_NO = :P385_ACCOUNT_NO
   GROUP BY
       AFL.ACCOUNT_NO
)
SELECT             
    NVL(AFLD.AMOUNT, 0) - NVL(REMM.AMOUNT, 0) AS FACILITIES_AMOUNT,
   REMM.AMOUNT AS LIMIT_UTILIZATION
FROM 
    AB_FACILITIES_LETTER_DET AFLD
LEFT JOIN 
    AB_FACILITIES_LETTER AFL ON AFL.ID = AFLD.MAST_ID
LEFT JOIN 
    REMAINING_BALANCE REMM ON REMM.ACCOUNT_NO = AFLD.ID 
WHERE 
    AFLD.ID = :P385_ACCOUNT_NO
    AND AFLD.ORG_ID = :GV_ORG_ID
    AND AFLD.AMOUNT IS NOT NULL

ORDER BY 
    AFLD.ID DESC;

--=========================================================================

