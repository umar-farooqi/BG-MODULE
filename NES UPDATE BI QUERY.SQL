WITH QUERY1 AS (
    SELECT 
        AFL.BANK_NAME,
        AFLD.FACILITIES_ID,
        MAX(CASE 
            WHEN ALD.DET_ID = AFLD.FACILITIES_ID AND ALD.LOOKUP_ID = '032' THEN ALD.LOOKUP_DET_NAME 
            ELSE NULL 
        END) AS FACILITIES_NAME,
        NVL(SUM(AFLD.AMOUNT), 0) AS AMOUNT
    FROM 
        AB_FACILITIES_LETTER AFL
    LEFT JOIN 
        AB_FACILITIES_LETTER_DET AFLD  
    ON 
        AFLD.MAST_ID = AFL.ID
    LEFT JOIN 
        AB_LOOKUP_DETAIL ALD 
    ON 
        ALD.DET_ID = AFLD.FACILITIES_ID
    WHERE 
        AFL.FACILITIES_TYPE = 'FACILITIES MAST'
        AND AFL.ORG_ID = NVL(:GV_ORG_ID, AFL.ORG_ID)
    GROUP BY 
        AFL.BANK_NAME, AFLD.FACILITIES_ID
),
QUERY2 AS (
    SELECT
        AFL.BANK_NAME,
        AFL.FACILITIES_ID,
        NVL(SUM(AFL.AMOUNT), 0) AS AVAILED
    FROM AB_FACILITIES_LETTER AFL
    LEFT JOIN AB_FACILITIES_LETTER_DET AFLD ON AFLD.MAST_ID = AFL.ID
    LEFT JOIN AB_LOOKUP_DETAIL ALD ON ALD.DET_ID = AFL.FACILITIES_ID
    WHERE AFL.FACILITIES_TYPE = 'LIMIT UTILIZATION'
    AND AFL.ORG_ID = NVL(:GV_ORG_ID, AFL.ORG_ID)
    GROUP BY 
        AFL.BANK_NAME, AFL.FACILITIES_ID
)
SELECT 
    Q1.BANK_NAME,
    Q1.FACILITIES_ID,
    Q1.FACILITIES_NAME,
    NVL(Q1.AMOUNT,0) AMOUNT,
    NVL(Q2.AVAILED,0) AVAILD
FROM 
    QUERY1 Q1
LEFT JOIN 
    QUERY2 Q2 
ON 
    Q1.BANK_NAME = Q2.BANK_NAME
    AND Q1.FACILITIES_ID = Q2.FACILITIES_ID;
====================================================
WITH QUERY1 AS (
    SELECT 
        AFL.BANK_NAME,
        AFLD.FACILITIES_ID,
        MAX(CASE 
            WHEN ALD.DET_ID = AFLD.FACILITIES_ID AND ALD.LOOKUP_ID = '032' THEN ALD.LOOKUP_DET_NAME 
            ELSE NULL 
        END) AS FACILITIES_NAME,
        NVL(SUM(AFLD.AMOUNT), 0) AS AMOUNT
    FROM 
        AB_FACILITIES_LETTER AFL
    LEFT JOIN 
        AB_FACILITIES_LETTER_DET AFLD  
    ON 
        AFLD.MAST_ID = AFL.ID
    LEFT JOIN 
        AB_LOOKUP_DETAIL ALD 
    ON 
        ALD.DET_ID = AFLD.FACILITIES_ID
    WHERE 
        AFL.FACILITIES_TYPE = 'FACILITIES MAST'
        AND AFL.ORG_ID = NVL(:GV_ORG_ID, AFL.ORG_ID)
    GROUP BY 
        AFL.BANK_NAME, AFLD.FACILITIES_ID
),
QUERY2 AS (
    SELECT
        AFL.BANK_NAME,
        AFL.FACILITIES_ID,
        NVL(SUM(AFL.AMOUNT), 0) AS AVAILED
    FROM AB_FACILITIES_LETTER AFL
    LEFT JOIN AB_FACILITIES_LETTER_DET AFLD ON AFLD.MAST_ID = AFL.ID
    LEFT JOIN AB_LOOKUP_DETAIL ALD ON ALD.DET_ID = AFL.FACILITIES_ID
    WHERE AFL.FACILITIES_TYPE = 'LIMIT UTILIZATION'
    AND AFL.ORG_ID = NVL(:GV_ORG_ID, AFL.ORG_ID)
    GROUP BY 
        AFL.BANK_NAME, AFL.FACILITIES_ID
)
SELECT 
    Q1.BANK_NAME,
   -- Q1.FACILITIES_ID,
    Q1.FACILITIES_NAME,
    NVL(Q1.AMOUNT,0) AMOUNT,
    NVL(Q2.AVAILED,0) AVAILD
FROM 
    QUERY1 Q1
LEFT JOIN 
    QUERY2 Q2 
ON 
    Q1.BANK_NAME = Q2.BANK_NAME
    AND Q1.FACILITIES_ID = Q2.FACILITIES_ID;
