WITH Facilities_Mast AS (
    SELECT 
        AFL.BANK_NAME,
        AFLD.FACILITIES_ID,
        MAX(CASE 
            WHEN ALD.DET_ID = AFLD.FACILITIES_ID AND ALD.LOOKUP_ID = '032' THEN ALD.LOOKUP_DET_NAME 
            ELSE NULL 
        END) AS FACILITIES_NAME,
        NVL(SUM(AFLD.AMOUNT), 0) AS AMOUNT
    FROM 
        AB_FACILITIES_LETTER AFL
    LEFT JOIN 
        AB_FACILITIES_LETTER_DET AFLD  
    ON 
        AFLD.MAST_ID = AFL.ID
    LEFT JOIN 
        AB_LOOKUP_DETAIL ALD 
    ON 
        ALD.DET_ID = AFLD.FACILITIES_ID
    WHERE 
        AFL.FACILITIES_TYPE = 'FACILITIES MAST'
        AND AFL.ORG_ID = NVL(:GV_ORG_ID, AFL.ORG_ID)
    GROUP BY 
        AFL.BANK_NAME,AFLD.FACILITIES_ID
),
Limit_Utilization AS (
    SELECT
    AFL.BANK_NAME,
        AFL.FACILITIES_ID,
        MAX(CASE 
            WHEN ALD.DET_ID = AFL.FACILITIES_ID AND ALD.LOOKUP_ID = '032' THEN ALD.LOOKUP_DET_NAME 
            ELSE NULL 
        END) AS FACILITIES_NAME,
        NVL(SUM(AFL.AMOUNT), 0) AS AVAILED
    FROM 
        AB_FACILITIES_LETTER AFL
    LEFT JOIN 
        AB_FACILITIES_LETTER_DET AFLD 
    ON 
        AFLD.MAST_ID = AFL.ID
    LEFT JOIN 
        AB_LOOKUP_DETAIL ALD 
    ON 
        ALD.DET_ID = AFL.FACILITIES_ID
    WHERE 
        AFL.FACILITIES_TYPE = 'LIMIT UTILIZATION'
        AND AFL.ORG_ID = NVL(:GV_ORG_ID, AFL.ORG_ID)
    GROUP BY 
        AFL.BANK_NAME, AFL.FACILITIES_ID
)
SELECT 
    COALESCE(FM.FACILITIES_ID, LU.FACILITIES_ID) AS FACILITIES_ID,
    COALESCE(FM.BANK_NAME, LU.BANK_NAME) AS BANK_NAME,
    COALESCE(FM.FACILITIES_NAME, LU.FACILITIES_NAME) AS FACILITIES_NAME,
    NVL(FM.AMOUNT, 0) AS AMOUNT,
    NVL(LU.AVAILED, 0) AS AVAILED,
    NVL(FM.AMOUNT, 0)  - NVL(LU.AVAILED, 0) AS BALANCE
FROM 
    Facilities_Mast FM
FULL OUTER JOIN 
    Limit_Utilization LU 
ON 
    FM.FACILITIES_ID = LU.FACILITIES_ID;
