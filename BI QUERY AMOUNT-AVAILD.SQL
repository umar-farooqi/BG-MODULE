-- BI QUERY FOR LIMIT_UTILIZATION
WITH FACILITY_LETTER AS (
    SELECT 
        AFL.BANK_NAME, 
        NVL(SUM(AFLD.AMOUNT), 0) AS AMOUNT,
        (SELECT NVL(SUM(AFLD_INNER.AMOUNT), 0)
         FROM AB_FACILITIES_LETTER AFL_INNER
         LEFT JOIN AB_FACILITIES_LETTER_DET AFLD_INNER 
         ON AFLD_INNER.MAST_ID = AFL_INNER.ID
         WHERE AFL_INNER.FACILITIES_TYPE = 'FACILITIES MAST'
         AND AFL_INNER.ORG_ID = NVL(:GV_ORG_ID,AFL_INNER.ORG_ID)
        ) AS TOTAL_SUM
    FROM 
        AB_FACILITIES_LETTER AFL
    LEFT JOIN 
        AB_FACILITIES_LETTER_DET AFLD 
    ON 
        AFLD.MAST_ID = AFL.ID
    WHERE 
        AFL.FACILITIES_TYPE = 'FACILITIES MAST'
        AND AFL.ORG_ID = NVL(:GV_ORG_ID,AFL.ORG_ID)
    GROUP BY 
        AFL.BANK_NAME
),
UTILIZATION AS (
    SELECT
        AFL.BANK_NAME,
        NVL(SUM(AFL.AMOUNT), 0) AS AVAILED,
        (SELECT NVL(SUM(AFL1.AMOUNT), 0) 
         FROM AB_FACILITIES_LETTER AFL1 
         WHERE AFL1.FACILITIES_TYPE = 'LIMIT UTILIZATION'
         AND AFL1.ORG_ID = NVL(:GV_ORG_ID, AFL1.ORG_ID)
        ) AS AMOUNT_AVAILED
    FROM AB_FACILITIES_LETTER AFL
    LEFT JOIN AB_FACILITIES_LETTER_DET AFLD ON AFLD.MAST_ID = AFL.ID
    WHERE AFL.FACILITIES_TYPE = 'LIMIT UTILIZATION'
    AND AFL.ORG_ID = NVL(:GV_ORG_ID, AFL.ORG_ID)
    GROUP BY 
        AFL.BANK_NAME
)
SELECT 
   FL.BANK_NAME,
    FL.AMOUNT, 
    FL.TOTAL_SUM,
    UT.AVAILED, 
    UT.AMOUNT_AVAILED,
      NVL(FL.AMOUNT, 0) - NVL(UT.AVAILED, 0) AS BALANCE,
    NVL(SUM(NVL(FL.AMOUNT, 0) - NVL(UT.AVAILED, 0)), 0) AS TOTAL_BALANCE

      
FROM 
    FACILITY_LETTER FL
LEFT JOIN 
    UTILIZATION UT 
ON 
    UT.BANK_NAME = FL.BANK_NAME
--==========================================================================
SELECT 
    AFL.BANK_NAME, 
    NVL(SUM(AFLD.AMOUNT), 0) AS AMOUNT,
    (SELECT NVL(SUM(AFLD_INNER.AMOUNT), 0)
     FROM AB_FACILITIES_LETTER AFL_INNER
     LEFT JOIN AB_FACILITIES_LETTER_DET AFLD_INNER 
     ON AFLD_INNER.MAST_ID = AFL_INNER.ID
     WHERE AFL_INNER.FACILITIES_TYPE = 'FACILITIES MAST'
     AND AFL_INNER.ORG_ID = :GV_ORG_ID
    ) AS TOTAL_SUM
FROM 
    AB_FACILITIES_LETTER AFL
LEFT JOIN 
    AB_FACILITIES_LETTER_DET AFLD 
ON 
    AFLD.MAST_ID = AFL.ID
WHERE 
    AFL.FACILITIES_TYPE = 'FACILITIES MAST'
    AND AFL.ORG_ID = :GV_ORG_ID
GROUP BY 
    AFL.BANK_NAME;

