BEGIN
    htp.p('<!DOCTYPE html>');
    htp.p('<html>
<head>
<style>
    .page { margin: 0 auto;width: 100%;padding: 0; /* Ensure no padding around the page */}  
    @page { margin: 10mm;}
    @media print { table { page-break-after:auto; } tr { page-break-inside:avoid; page-break-after:auto; }td { page-break-inside:avoid; page-break-after:auto; }thead { display:table-header-group; }tfoot { display:table-footer-group; }}
    #left { width: 15%;float: left;padding: 0; /* Remove padding */margin-left: 0; /* Remove margin to align to left */}
    #right { width: 85%; /* Adjust width to accommodate more space for the right side */float: left; /* Ensures both left and right align side by side */text-align: center;padding: 0; /* Remove padding */margin-right: 0; /* Remove margin */}
    p { text-align: center;font-size: 12px; /* Reduced font size */margin: 4px 0;}
    table { width: 100%; /* Full width for each table */margin: 0; /* Removed margin to reduce the gap */border-collapse: collapse;}         
    tr { page-break-inside: avoid;page-break-after: auto;height: 20px; /* Sets a fixed height for rows */}
    th, td { border: 1px solid #D0F0C0;text-align: center;font-size: 8px; /* Decreased font size */height: 40px; /* Fixed row height */overflow: hidden; /* Ensures content doesnt overflow */word-wrap: break-word; /* Break long words to fit in the cell */}
    th { text-align: center;font-size: 8px;padding-top: 0.1em;padding-bottom: 0.1em;width: 100%; /* Ensure equal width for all headers */}
    th { word-wrap: break-word;overflow: hidden;}
    .flex-container { display: flex;/* justify-content: space-between;*/align-items: flex-start; /* Prevent stretching */gap: 0px; /* Space between tables */flex-wrap: wrap;}
    #t1, #t2, #t4, #t5 { width: 24.9%; /* Each table takes up 19.9% of the available space */margin: 0; /* Remove bottom margin to eliminate extra space */padding: 0; /* Eliminate padding */}
    #t1, #t2, #t4, #t5 {margin-bottom: 8px; /* Add some space between rows of tables if needed */}
    .header { padding: 1px 1px; /* Equalize padding for all headers */background-color:#7AAE43; color:white;font-size: 10px;}
    #t3 { width: 100%;background-color:#689D3A; color:white;margin-bottom: 2px; /* Add some space between rows of tables if needed */width: 99.5%;}
    #t7 { width: 99.5%;background-color: #D0F0C0;margin-bottom: 0px;border-collapse: collapse; /* Ensures no extra space between borders */}
    #t7 td { padding: 1px 1px; /* Minimized padding */line-height: 0; /* Reduces the height of the text line */font-size: 12px; /* Optional: Reduce font size to further minimize height */}
    #t9{ width: 99.5%;margin-bottom: 0px;} #t9 td {word-wrap: break-word;}
    #t10{ width: 99.5%;margin-bottom: 0px;} #t9 td {word-wrap: break-word;}
  </style>
   <script>
        function adjustColumnWidth() {
          var table = document.querySelector("table");
          var itemNameColumnIndex = 1; // Index for ITEM NAME column
          var maxWidth = 0;
          var rows = table.querySelectorAll("tbody tr");
          
          rows.forEach(function(row) {
            var itemNameCell = row.cells[itemNameColumnIndex];
            if (itemNameCell) {
              var cellWidth = itemNameCell.scrollWidth;
              if (cellWidth > maxWidth) {
                maxWidth = cellWidth;
              }
            }
          });
          
          var header = table.querySelector("thead th.item-name-column");
          if (header) {
            header.style.width = maxWidth + "px";
          }
          
          var dataCells = table.querySelectorAll("tbody td.item-name-column");
          dataCells.forEach(function(cell) {
            cell.style.width = maxWidth + "px";
          });
        }
       
        function printDiv(printpage) {
          adjustColumnWidth();
          var headstr = "<html><head><title></title><style>";
          headstr += "@page { size: A4 landscape; margin: 10mm; }";
          headstr += "body { margin: 0; padding: 0; font-family: Arial, sans-serif; }";
          headstr += ".button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }";
          headstr += ".button1 { font-size: 16px; }";
          headstr += "table { border-collapse: collapse; width: 100%; margin: 0; padding: 0; }";
          headstr += "th, td { text-align: left; padding: 3px; font-size: 10px; line-height: 1.1; }";
          headstr += "th { background-color: rgba(146, 208, 80, 0.237); -webkit-print-color-adjust: exact; print-color-adjust: exact; }";
          headstr += ".separator { border-top: 1px solid black; }";
          headstr += "h3 { margin: 0; display: flex; align-items: center; justify-content: center; background-color: rgba(146, 208, 80); border: 1px solid black; -webkit-print-color-adjust: exact; print-color-adjust: exact; }";
          headstr += "@media print { thead {display: table-header-group;} tfoot {display: table-footer-group;} }";
          headstr += "h2 { font-size: 20px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 0; padding: 0; text-align: center; }";
          headstr += "#div_print1 { margin: 0; padding: 0; }";
          headstr += "</style></head><body>";
          var footstr = "</body></html>";
          var newstr = document.getElementById(printpage).innerHTML;
          var oldstr = document.body.innerHTML;
          document.body.innerHTML = headstr + newstr + footstr;
          window.print();
          document.body.innerHTML = oldstr;
          return false;
        }
      </script>
</head>');

    htp.p('<body>');
    htp.p('<button class="button" onclick="printDiv(''all_reports'')">Print Reports</button>');
    htp.p('<div id="all_reports">');
   
   htp.p('<table id="t9" >');
   htp.p('<tr> <th colspan="13" class="header">Financial</th> </tr>');
   htp.p('<tr>
      <th style="width:4%;background-color:#C2DEA4;">Bank Name</th>
      <th style="width:6%;background-color:#C2DEA4;">Company Name</th>
      <th style="width:4%;background-color:#C2DEA4;">Account No</th>
      <th style="width:6%;background-color:#C2DEA4;">Facilities Name</th>
      <th style="width:4%;background-color:#C2DEA4;">Total Amount</th>
      <th style="width:6%;background-color:#C2DEA4;">Availed</th>
      <th style="width:4%;background-color:#C2DEA4;">Balance</th>
      <th style="width:6%;background-color:#C2DEA4;">Maturity</th>
      <th style="width:4%;background-color:#C2DEA4;">Tomorrow</th>
      <th style="width:6%;background-color:#C2DEA4;">Day After Tomorrow</th>
      <th style="width:4%;background-color:#C2DEA4;">Over Due</th>
      
 </tr>');
DECLARE
  PREV_BANK_NAME VARCHAR2(1000) := NULL;
  PREV_FACILITIES_NAME VARCHAR2(1000) := NULL;
  PREV_TOTAL_AMOUNT VARCHAR2(1000) := NULL;
  PREV_BALANCE VARCHAR2(1000) := NULL;
BEGIN
  FOR x IN (
                   WITH BANK_NAME AS (
    SELECT
        ASM.SR_ID,
        AST.REG_NAME
    FROM
        AB_SETUP_REGISTRATION ASM
    JOIN
        AB_SETUP_REGISTRATION AST
    ON
        AST.SR_ID = ASM.SR_IDS 
        AND AST.REG_TYPE = 'BANK'
    WHERE 
        ASM.REG_TYPE = 'BANK LOV'
        AND ASM.ORG_ID = :GV_ORG_ID
    ORDER BY
        ASM.CREATED_ON DESC
), ACCOUNT_NOO AS (
    SELECT   
            ASM.REG_CODE ,
            AFLDS.ID,
            AFLD.ID AS IDD
    FROM 
            AB_SETUP_REGISTRATION ASM
      LEFT JOIN AB_FACILITIES_LETTER_DET AFLDS ON  AFLDS.ACCOUNT_NO = ASM.SR_ID 
      LEFT JOIN AB_FACILITIES_LETTER_DET AFLD ON AFLD.ID = AFLDS.IDS
      LEFT JOIN AB_FACILITIES_LETTER AFL ON AFL.ID = AFLD.MAST_ID
   WHERE 
       AFLDS.IMAGE_TYPE = 'FACILITIES ACCOUNT NUMBER'
   
         AND  AFLDS.ORG_ID = :GV_ORG_ID
),COMPANY_NAME AS (
      SELECT  ASM.REG_NAME  , AFLDS.COMPANY_NAME, AFLD.ID
        
     FROM

     AB_SETUP_REGISTRATION ASM  
             left join AB_FACILITIES_LETTER_DET AFLDS ON  AFLDS.COMPANY_NAME = ASM.SR_ID  AND ASM.REG_TYPE = 'COMPANY'
     LEFT  JOIN AB_FACILITIES_LETTER_DET AFLD ON AFLDS.IDS = AFLD.ID
     LEFT JOIN AB_FACILITIES_LETTER AFL ON AFL.ID = AFLD.MAST_ID

   WHERE 
       AFLDS.IMAGE_TYPE = 'FACILITIES COMPANY'

         AND  AFLDS.ORG_ID = :GV_ORG_ID
)
,QUERY1 AS (
    SELECT 
                    AFLD.ID,
                    AFL.BANK_ID,
                    AFLD.FACILITIES_ID,
                    BN.REG_NAME,
                    MAX(CASE WHEN ALD.DET_ID = AFLD.FACILITIES_ID AND ALD.LOOKUP_ID = '032' THEN ALD.LOOKUP_DET_NAME ELSE NULL END) AS FACILITIES_NAME,
                    SUM(NVL(AFLD.AMOUNT, 0)) AS AMOUNT 
    FROM 
                      AB_FACILITIES_LETTER AFL
    LEFT JOIN  AB_FACILITIES_LETTER_DET AFLD  ON AFLD.MAST_ID = AFL.ID
    LEFT JOIN  AB_LOOKUP_DETAIL ALD ON ALD.DET_ID = AFLD.FACILITIES_ID
    LEFT JOIN  BANK_NAME BN ON  BN.SR_ID = AFL.BANK_ID
    WHERE 
        AFL.FACILITIES_TYPE = 'FACILITIES MAST'
        AND AFL.ORG_ID = NVL(:GV_ORG_ID, AFL.ORG_ID)
    GROUP BY 
        AFL.BANK_ID, AFLD.FACILITIES_ID, BN.REG_NAME, AFLD.ID
),
QUERY2 AS (
    SELECT
        AFLD.ID,
        AFL.BANK_ID,
        AFL.FACILITIES_ID,
        AFL.MATURITY_TYPE,
        ( NVL(SUM(AFL.AMOUNT), 0)) AS AVAILED, -- Handle duplicates
        MAX(AFL.BG_EXPIRE_DATE) AS BG_EXPIRE_DATE,
        SUM(CASE 
            WHEN TRUNC(AFL.BG_EXPIRE_DATE) = TRUNC(SYSDATE) THEN AFL.AMOUNT
            ELSE 0
        END) AS MATURITY,
        SUM(CASE 
            WHEN TRUNC(AFL.BG_EXPIRE_DATE) = TRUNC(SYSDATE - 1) THEN AFL.AMOUNT
            ELSE 0
        END) AS TOMORROW,
        SUM(CASE 
            WHEN TRUNC(AFL.BG_EXPIRE_DATE) <= TRUNC(SYSDATE - 2) THEN AFL.AMOUNT
            ELSE 0
        END) AS DAY_AFTER_TOMORROW,
        SUM(CASE 
            WHEN TRUNC(AFL.BG_EXPIRE_DATE) > TRUNC(SYSDATE) THEN AFL.AMOUNT
            ELSE 0
        END) AS OVER_DUE
    FROM 
        AB_FACILITIES_LETTER AFL
    LEFT JOIN 
        AB_FACILITIES_LETTER_DET AFLD 
    ON 
        AFLD.MAST_ID = AFL.ID
    WHERE 
        AFL.FACILITIES_TYPE = 'LIMIT UTILIZATION'
        AND AFL.ORG_ID = NVL(:GV_ORG_ID, AFL.ORG_ID)
    GROUP BY 
        AFL.BANK_ID, AFL.FACILITIES_ID, AFL.MATURITY_TYPE, AFLD.ID 
)
,BANK_AMOUNT AS(
   SELECT 
                ACCOUNT_NO,
                AFL.BANK_ID,
                NVL(SUM(AFL.AMOUNT), 0) AS AMOUNT
    FROM 
                      AB_FACILITIES_LETTER AFL
    WHERE 
                     AFL.FACILITIES_TYPE = 'LIMIT UTILIZATION'
            AND AFL.ORG_ID = NVL(:GV_ORG_ID, AFL.ORG_ID)
    GROUP BY 
                ACCOUNT_NO,
                AFL.BANK_ID
)
,LIMIT_UTILIZATION AS(
SELECT
    Q1.BANK_ID AS BANK_ID, 
    
    Q1.REG_NAME AS BANK_NAME,
  CN.REG_NAME AS COMPANY_NAME,
  ACC.REG_CODE AS ACCOUNT_NO,
    Q1.FACILITIES_NAME AS FACILITIES_NAME,
    SUM(Q1.AMOUNT)AS TOTAL_AMOUNT,
     MAX(Q2.AVAILED) AS AVAILED,
      SUM(Q1.AMOUNT) - Q2.AVAILED AS BALANCE, 
    SUM(Q2.MATURITY) AS MATURITY,
    SUM(Q2.TOMORROW) AS TOMORROW,
    SUM(Q2.DAY_AFTER_TOMORROW) AS DAY_AFTER_TOMORROW,
    SUM(Q2.OVER_DUE) AS OVER_DUE,
    Q1.FACILITIES_ID,
    ACC.ID
FROM 
    QUERY1 Q1
LEFT JOIN 
    QUERY2 Q2 
ON 
    Q1.BANK_ID = Q2.BANK_ID
     AND Q1.FACILITIES_ID = Q2.FACILITIES_ID
    LEFT JOIN ACCOUNT_NOO ACC ON ACC.IDD = Q1.ID
    LEFT JOIN COMPANY_NAME CN ON CN.ID = Q1.ID
WHERE 
    Q2.MATURITY_TYPE = 'FINANCIAL'
GROUP BY 
    Q1.BANK_ID, 
    Q1.REG_NAME,
   Q2.AVAILED,
  CN.REG_NAME,
  ACC.REG_CODE,
    Q1.FACILITIES_NAME,
    Q1.FACILITIES_ID,
    ACC.ID
)
,FACILITIES_NAME AS(
SELECT
               BANK_ID,
                FACILITIES_NAME,
                FACILITIES_ID,
                SUM( DISTINCT NVL(TOTAL_AMOUNT,0)) TOTAL_AMOUNT
    FROM(
    SELECT
    Q1.BANK_ID AS BANK_ID, 
    Q1.REG_NAME AS BANK_NAME,
  CN.REG_NAME AS COMPANY_NAME,
  ACC.REG_CODE AS ACCOUNT_NO,
   Q1.FACILITIES_ID,
    Q1.FACILITIES_NAME AS FACILITIES_NAME,
    SUM( Q1.AMOUNT)AS TOTAL_AMOUNT,
     MAX(Q2.AVAILED) AS AVAILED,
      SUM(Q1.AMOUNT) - Q2.AVAILED AS BALANCE, 
    SUM(Q2.MATURITY) AS MATURITY,
    SUM(Q2.TOMORROW) AS TOMORROW,
    SUM(Q2.DAY_AFTER_TOMORROW) AS DAY_AFTER_TOMORROW,
    SUM(Q2.OVER_DUE) AS OVER_DUE
FROM 
    QUERY1 Q1
LEFT JOIN 
    QUERY2 Q2 
ON 
    Q1.BANK_ID = Q2.BANK_ID
     AND Q1.FACILITIES_ID = Q2.FACILITIES_ID
    LEFT JOIN ACCOUNT_NOO ACC ON ACC.IDD = Q1.ID
    LEFT JOIN COMPANY_NAME CN ON CN.ID = Q1.ID
WHERE 
    Q2.MATURITY_TYPE = 'FINANCIAL'
GROUP BY 
    Q1.BANK_ID, 
    Q1.REG_NAME,
   Q2.AVAILED,
  CN.REG_NAME,
  ACC.REG_CODE,
    Q1.FACILITIES_NAME,
    Q1.FACILITIES_ID)
  GROUP BY
            BANK_ID,
            FACILITIES_NAME,
            FACILITIES_ID
 ),
LIMIT_AMOUNT AS( SELECT 
                ACCOUNT_NO,
                AFL.BANK_ID,
                NVL(SUM(AFL.AMOUNT), 0) AS AMOUNT
    FROM 
                      AB_FACILITIES_LETTER AFL
    WHERE 
                     AFL.FACILITIES_TYPE = 'LIMIT UTILIZATION'
            AND AFL.ORG_ID = NVL(:GV_ORG_ID, AFL.ORG_ID)
    GROUP BY 
                ACCOUNT_NO,
                AFL.BANK_ID
 )
 ,FINAL_SUM AS(
    SELECT
             LU.BANK_ID,
             LU.BANK_NAME,
             COMPANY_NAME,
             LU.ACCOUNT_NO,
             LU.FACILITIES_NAME,
             FN.TOTAL_AMOUNT,
             LA.AMOUNT AVAILED,
             0 BALANCE,
             LU.MATURITY,
            LU.TOMORROW,
            LU.DAY_AFTER_TOMORROW,
            LU.OVER_DUE,
            LU.FACILITIES_ID
    FROM
                      LIMIT_UTILIZATION LU 
    LEFT JOIN  FACILITIES_NAME FN ON FN.BANK_ID=LU.BANK_ID
             AND FN.FACILITIES_ID=LU.FACILITIES_ID
    LEFT JOIN LIMIT_AMOUNT  LA ON LA.BANK_ID=LU.BANK_ID
             AND  LA.ACCOUNT_NO=LU.ID
)
,BALANCE_AMOUNT AS(SELECT
           BANK_ID ,
            SUM(DISTINCT NVL(TOTAL_AMOUNT, 0)) - SUM(DISTINCT NVL(AVAILED, 0)) AS BALANCE,
       --  SUM( NVL(AVAILED,0)) BALANCE,
          FACILITIES_ID
    FROM
           FINAL_SUM FS
        GROUP BY
          BANK_ID ,
          FACILITIES_ID
           )
    SELECT
             LU.BANK_ID,
             LU.BANK_NAME,
             COUNT(*) OVER (PARTITION BY LU.BANK_NAME) AS BANK_ROWSPAN,
             COUNT(*) OVER (PARTITION BY LU.BANK_NAME, FACILITIES_NAME) AS  FACILITIES_ROWSPAN,
             COUNT(*) OVER (PARTITION BY LU.BANK_NAME, FACILITIES_NAME , TOTAL_AMOUNT) AS AMOUNT_ROWSPAN,
             COUNT(*) OVER (PARTITION BY LU.BANK_NAME, FACILITIES_NAME , TOTAL_AMOUNT,BA.BALANCE) AS BALANCE_ROWSPAN,
             TOTAL_AMOUNT,
             COMPANY_NAME,
             ACCOUNT_NO,
             FACILITIES_NAME,
          
             AVAILED,
           BA.BALANCE,
         
             LU.MATURITY,
             LU.TOMORROW,
             LU.DAY_AFTER_TOMORROW,
             LU.OVER_DUE,
             LU.FACILITIES_ID
    FROM
                        FINAL_SUM LU 
     LEFT JOIN  BALANCE_AMOUNT BA ON BA.FACILITIES_ID=LU.FACILITIES_ID
 ) LOOP
    
    htp.p('<tr>');
    
    IF PREV_BANK_NAME IS NULL OR x.BANK_NAME <> PREV_BANK_NAME THEN
      htp.p('<td rowspan="'||x.BANK_ROWSPAN||'">'||htf.escape_sc(x.BANK_NAME)||'</td>');
    END IF;
        htp.p('<td>'||NVL(htf.escape_sc(x.COMPANY_NAME), '0')||'</td>');
    htp.p('<td>'||NVL(htf.escape_sc(x.ACCOUNT_NO), '0')||'</td>');


     IF PREV_FACILITIES_NAME IS NULL OR x.FACILITIES_NAME <> PREV_FACILITIES_NAME THEN
      htp.p('<td rowspan="'||x.FACILITIES_ROWSPAN||'">'||htf.escape_sc(x.FACILITIES_NAME)||'</td>');
    END IF;
    
    
     IF PREV_TOTAL_AMOUNT IS NULL OR x.TOTAL_AMOUNT <> PREV_TOTAL_AMOUNT THEN
      htp.p('<td rowspan="'||x.AMOUNT_ROWSPAN||'">'||htf.escape_sc(x.TOTAL_AMOUNT)||'</td>');
    END IF;
    
    htp.p('<td>'||NVL(htf.escape_sc(x.AVAILED), '0')||'</td>');
      IF PREV_BALANCE IS NULL OR x.BALANCE <> PREV_BALANCE THEN
      htp.p('<td rowspan="'||x.BALANCE_ROWSPAN||'">'||htf.escape_sc(x.BALANCE)||'</td>');
    END IF;
   
    htp.p('<td>'||NVL(htf.escape_sc(x.MATURITY), '0')||'</td>');
    htp.p('<td>'||NVL(htf.escape_sc(x.TOMORROW), '0')||'</td>');
    htp.p('<td>'||NVL(htf.escape_sc(x.DAY_AFTER_TOMORROW), '0')||'</td>');
    htp.p('<td>'||NVL(htf.escape_sc(x.OVER_DUE), '0')||'</td>');
    htp.p('</tr>');
    
    PREV_BANK_NAME := x.BANK_NAME;
    PREV_FACILITIES_NAME := x.FACILITIES_NAME;
    PREV_TOTAL_AMOUNT := x.TOTAL_AMOUNT;
    PREV_BALANCE := x.BALANCE;
  END LOOP;  
END;
  

htp.p('</body>');htp.p('</html>');END;


---------------------------------------
BEGIN
    htp.p('<!DOCTYPE html>');
    htp.p('<html>
<head>
<style>
    .page { margin: 0 auto;width: 100%;padding: 0; /* Ensure no padding around the page */}  
    @page { margin: 10mm;}
    @media print { table { page-break-after:auto; } tr { page-break-inside:avoid; page-break-after:auto; }td { page-break-inside:avoid; page-break-after:auto; }thead { display:table-header-group; }tfoot { display:table-footer-group; }}
    #left { width: 15%;float: left;padding: 0; /* Remove padding */margin-left: 0; /* Remove margin to align to left */}
    #right { width: 85%; /* Adjust width to accommodate more space for the right side */float: left; /* Ensures both left and right align side by side */text-align: center;padding: 0; /* Remove padding */margin-right: 0; /* Remove margin */}
    p { text-align: center;font-size: 12px; /* Reduced font size */margin: 4px 0;}
    table { width: 100%; /* Full width for each table */margin: 0; /* Removed margin to reduce the gap */border-collapse: collapse;}         
    tr { page-break-inside: avoid;page-break-after: auto;height: 20px; /* Sets a fixed height for rows */}
    th, td { border: 1px solid #D0F0C0;text-align: center;font-size: 8px; /* Decreased font size */height: 40px; /* Fixed row height */overflow: hidden; /* Ensures content doesnt overflow */word-wrap: break-word; /* Break long words to fit in the cell */}
    th { text-align: center;font-size: 8px;padding-top: 0.1em;padding-bottom: 0.1em;width: 100%; /* Ensure equal width for all headers */}
    th { word-wrap: break-word;overflow: hidden;}
    .flex-container { display: flex;/* justify-content: space-between;*/align-items: flex-start; /* Prevent stretching */gap: 0px; /* Space between tables */flex-wrap: wrap;}
    #t1, #t2, #t4, #t5 { width: 24.9%; /* Each table takes up 19.9% of the available space */margin: 0; /* Remove bottom margin to eliminate extra space */padding: 0; /* Eliminate padding */}
    #t1, #t2, #t4, #t5 {margin-bottom: 8px; /* Add some space between rows of tables if needed */}
    .header { padding: 1px 1px; /* Equalize padding for all headers */background-color:#7AAE43; color:white;font-size: 10px;}
    #t3 { width: 100%;background-color:#689D3A; color:white;margin-bottom: 2px; /* Add some space between rows of tables if needed */width: 99.5%;}
    #t7 { width: 99.5%;background-color: #D0F0C0;margin-bottom: 0px;border-collapse: collapse; /* Ensures no extra space between borders */}
    #t7 td { padding: 1px 1px; /* Minimized padding */line-height: 0; /* Reduces the height of the text line */font-size: 12px; /* Optional: Reduce font size to further minimize height */}
    #t9{ width: 99.5%;margin-bottom: 0px;} #t9 td {word-wrap: break-word;}
    #t10{ width: 99.5%;margin-bottom: 0px;} #t9 td {word-wrap: break-word;}
  </style>
</head>');
    htp.p('<body>');
   
   htp.p('<table id="t9" >');
   htp.p('<tr> <th colspan="13" class="header">Non Financial</th> </tr>');
   htp.p('<tr>
      <th style="width:4%;background-color:#C2DEA4;">Bank Name</th>
      <th style="width:6%;background-color:#C2DEA4;">Company Name</th>
      <th style="width:4%;background-color:#C2DEA4;">Account No</th>
      <th style="width:6%;background-color:#C2DEA4;">Facilities Name</th>
      <th style="width:4%;background-color:#C2DEA4;">Total Amount</th>
      <th style="width:6%;background-color:#C2DEA4;">Availed</th>
      <th style="width:4%;background-color:#C2DEA4;">Balance</th>
      
 </tr>');
DECLARE
  PREV_BANK_NAME VARCHAR2(1000) := NULL;
  PREV_FACILITIES_NAME VARCHAR2(1000) := NULL;
  PREV_TOTAL_AMOUNT VARCHAR2(1000) := NULL;
  PREV_BALANCE VARCHAR2(1000) := NULL;
BEGIN
  FOR x IN (
      WITH BANK_NAME AS (
    SELECT
        ASM.SR_ID,
        AST.REG_NAME
    FROM
        AB_SETUP_REGISTRATION ASM
    JOIN
        AB_SETUP_REGISTRATION AST
    ON
        AST.SR_ID = ASM.SR_IDS 
        AND AST.REG_TYPE = 'BANK'
    WHERE 
        ASM.REG_TYPE = 'BANK LOV'
        AND ASM.ORG_ID = :GV_ORG_ID
    ORDER BY
        ASM.CREATED_ON DESC
), ACCOUNT_NOO AS (
    SELECT   
            ASM.REG_CODE ,
            AFLDS.ID,
            AFLD.ID AS IDD
    FROM 
            AB_SETUP_REGISTRATION ASM
      LEFT JOIN AB_FACILITIES_LETTER_DET AFLDS ON  AFLDS.ACCOUNT_NO = ASM.SR_ID 
      LEFT JOIN AB_FACILITIES_LETTER_DET AFLD ON AFLD.ID = AFLDS.IDS
      LEFT JOIN AB_FACILITIES_LETTER AFL ON AFL.ID = AFLD.MAST_ID
   WHERE 
       AFLDS.IMAGE_TYPE = 'FACILITIES ACCOUNT NUMBER'
   
         AND  AFLDS.ORG_ID = :GV_ORG_ID
),COMPANY_NAME AS (
      SELECT  ASM.REG_NAME  , AFLDS.COMPANY_NAME, AFLD.ID
        
     FROM

     AB_SETUP_REGISTRATION ASM  
             left join AB_FACILITIES_LETTER_DET AFLDS ON  AFLDS.COMPANY_NAME = ASM.SR_ID  AND ASM.REG_TYPE = 'COMPANY'
     LEFT  JOIN AB_FACILITIES_LETTER_DET AFLD ON AFLDS.IDS = AFLD.ID
     LEFT JOIN AB_FACILITIES_LETTER AFL ON AFL.ID = AFLD.MAST_ID

   WHERE 
       AFLDS.IMAGE_TYPE = 'FACILITIES COMPANY'

         AND  AFLDS.ORG_ID = :GV_ORG_ID
)
,QUERY1 AS (
    SELECT 
                    AFLD.ID,
                    AFL.BANK_ID,
                    AFLD.FACILITIES_ID,
                    BN.REG_NAME,
                    MAX(CASE WHEN ALD.DET_ID = AFLD.FACILITIES_ID AND ALD.LOOKUP_ID = '032' THEN ALD.LOOKUP_DET_NAME ELSE NULL END) AS FACILITIES_NAME,
                    SUM(NVL(AFLD.AMOUNT, 0)) AS AMOUNT 
    FROM 
                      AB_FACILITIES_LETTER AFL
    LEFT JOIN  AB_FACILITIES_LETTER_DET AFLD  ON AFLD.MAST_ID = AFL.ID
    LEFT JOIN  AB_LOOKUP_DETAIL ALD ON ALD.DET_ID = AFLD.FACILITIES_ID
    LEFT JOIN  BANK_NAME BN ON  BN.SR_ID = AFL.BANK_ID
    WHERE 
        AFL.FACILITIES_TYPE = 'FACILITIES MAST'
        AND AFL.ORG_ID = NVL(:GV_ORG_ID, AFL.ORG_ID)
    GROUP BY 
        AFL.BANK_ID, AFLD.FACILITIES_ID, BN.REG_NAME, AFLD.ID
),
QUERY2 AS (
    SELECT
        AFLD.ID,
        AFL.BANK_ID,
        AFL.FACILITIES_ID,
        AFL.MATURITY_TYPE,
        ( NVL(SUM(AFL.AMOUNT), 0)) AS AVAILED, -- Handle duplicates
        MAX(AFL.BG_EXPIRE_DATE) AS BG_EXPIRE_DATE,
        SUM(CASE 
            WHEN TRUNC(AFL.BG_EXPIRE_DATE) = TRUNC(SYSDATE) THEN AFL.AMOUNT
            ELSE 0
        END) AS MATURITY,
        SUM(CASE 
            WHEN TRUNC(AFL.BG_EXPIRE_DATE) = TRUNC(SYSDATE - 1) THEN AFL.AMOUNT
            ELSE 0
        END) AS TOMORROW,
        SUM(CASE 
            WHEN TRUNC(AFL.BG_EXPIRE_DATE) <= TRUNC(SYSDATE - 2) THEN AFL.AMOUNT
            ELSE 0
        END) AS DAY_AFTER_TOMORROW,
        SUM(CASE 
            WHEN TRUNC(AFL.BG_EXPIRE_DATE) > TRUNC(SYSDATE) THEN AFL.AMOUNT
            ELSE 0
        END) AS OVER_DUE
    FROM 
        AB_FACILITIES_LETTER AFL
    LEFT JOIN 
        AB_FACILITIES_LETTER_DET AFLD 
    ON 
        AFLD.MAST_ID = AFL.ID
    WHERE 
        AFL.FACILITIES_TYPE = 'LIMIT UTILIZATION'
        AND AFL.ORG_ID = NVL(:GV_ORG_ID, AFL.ORG_ID)
    GROUP BY 
        AFL.BANK_ID, AFL.FACILITIES_ID, AFL.MATURITY_TYPE, AFLD.ID 
)
,BANK_AMOUNT AS(
   SELECT 
                ACCOUNT_NO,
                AFL.BANK_ID,
                NVL(SUM(AFL.AMOUNT), 0) AS AMOUNT
    FROM 
                      AB_FACILITIES_LETTER AFL
    WHERE 
                     AFL.FACILITIES_TYPE = 'LIMIT UTILIZATION'
            AND AFL.ORG_ID = NVL(:GV_ORG_ID, AFL.ORG_ID)
    GROUP BY 
                ACCOUNT_NO,
                AFL.BANK_ID
)
,LIMIT_UTILIZATION AS(
SELECT
    Q1.BANK_ID AS BANK_ID, 
    
    Q1.REG_NAME AS BANK_NAME,
  CN.REG_NAME AS COMPANY_NAME,
  ACC.REG_CODE AS ACCOUNT_NO,
    Q1.FACILITIES_NAME AS FACILITIES_NAME,
    SUM(Q1.AMOUNT)AS TOTAL_AMOUNT,
     MAX(Q2.AVAILED) AS AVAILED,
      SUM(Q1.AMOUNT) - Q2.AVAILED AS BALANCE, 
    SUM(Q2.MATURITY) AS MATURITY,
    SUM(Q2.TOMORROW) AS TOMORROW,
    SUM(Q2.DAY_AFTER_TOMORROW) AS DAY_AFTER_TOMORROW,
    SUM(Q2.OVER_DUE) AS OVER_DUE,
    Q1.FACILITIES_ID,
    ACC.ID
FROM 
    QUERY1 Q1
LEFT JOIN 
    QUERY2 Q2 
ON 
    Q1.BANK_ID = Q2.BANK_ID
     AND Q1.FACILITIES_ID = Q2.FACILITIES_ID
    LEFT JOIN ACCOUNT_NOO ACC ON ACC.IDD = Q1.ID
    LEFT JOIN COMPANY_NAME CN ON CN.ID = Q1.ID
WHERE 
    Q2.MATURITY_TYPE = 'NON FINANCIAL'
GROUP BY 
    Q1.BANK_ID, 
    Q1.REG_NAME,
   Q2.AVAILED,
  CN.REG_NAME,
  ACC.REG_CODE,
    Q1.FACILITIES_NAME,
    Q1.FACILITIES_ID,
    ACC.ID
)
,FACILITIES_NAME AS(
SELECT
               BANK_ID,
                FACILITIES_NAME,
                FACILITIES_ID,
                SUM( DISTINCT NVL(TOTAL_AMOUNT,0)) TOTAL_AMOUNT
    FROM(
    SELECT
    Q1.BANK_ID AS BANK_ID, 
    Q1.REG_NAME AS BANK_NAME,
  CN.REG_NAME AS COMPANY_NAME,
  ACC.REG_CODE AS ACCOUNT_NO,
   Q1.FACILITIES_ID,
    Q1.FACILITIES_NAME AS FACILITIES_NAME,
    SUM( Q1.AMOUNT)AS TOTAL_AMOUNT,
     MAX(Q2.AVAILED) AS AVAILED,
      SUM(Q1.AMOUNT) - Q2.AVAILED AS BALANCE, 
    SUM(Q2.MATURITY) AS MATURITY,
    SUM(Q2.TOMORROW) AS TOMORROW,
    SUM(Q2.DAY_AFTER_TOMORROW) AS DAY_AFTER_TOMORROW,
    SUM(Q2.OVER_DUE) AS OVER_DUE
FROM 
    QUERY1 Q1
LEFT JOIN 
    QUERY2 Q2 
ON 
    Q1.BANK_ID = Q2.BANK_ID
     AND Q1.FACILITIES_ID = Q2.FACILITIES_ID
    LEFT JOIN ACCOUNT_NOO ACC ON ACC.IDD = Q1.ID
    LEFT JOIN COMPANY_NAME CN ON CN.ID = Q1.ID
WHERE 
    Q2.MATURITY_TYPE = 'NON FINANCIAL'
GROUP BY 
    Q1.BANK_ID, 
    Q1.REG_NAME,
   Q2.AVAILED,
  CN.REG_NAME,
  ACC.REG_CODE,
    Q1.FACILITIES_NAME,
    Q1.FACILITIES_ID)
  GROUP BY
            BANK_ID,
            FACILITIES_NAME,
            FACILITIES_ID
 ),
LIMIT_AMOUNT AS( SELECT 
                ACCOUNT_NO,
                AFL.BANK_ID,
                NVL(SUM(AFL.AMOUNT), 0) AS AMOUNT
    FROM 
                      AB_FACILITIES_LETTER AFL
    WHERE 
                     AFL.FACILITIES_TYPE = 'LIMIT UTILIZATION'
            AND AFL.ORG_ID = NVL(:GV_ORG_ID, AFL.ORG_ID)
    GROUP BY 
                ACCOUNT_NO,
                AFL.BANK_ID
 )
 ,FINAL_SUM AS(
    SELECT
             LU.BANK_ID,
             LU.BANK_NAME,
             COMPANY_NAME,
             LU.ACCOUNT_NO,
             LU.FACILITIES_NAME,
             FN.TOTAL_AMOUNT,
             LA.AMOUNT AVAILED,
             0 BALANCE,
             LU.MATURITY,
            LU.TOMORROW,
            LU.DAY_AFTER_TOMORROW,
            LU.OVER_DUE,
            LU.FACILITIES_ID
    FROM
                      LIMIT_UTILIZATION LU 
    LEFT JOIN  FACILITIES_NAME FN ON FN.BANK_ID=LU.BANK_ID
             AND FN.FACILITIES_ID=LU.FACILITIES_ID
    LEFT JOIN LIMIT_AMOUNT  LA ON LA.BANK_ID=LU.BANK_ID
             AND  LA.ACCOUNT_NO=LU.ID
)
,BALANCE_AMOUNT AS(SELECT
          FS.BANK_ID,
          SUM(DISTINCT NVL(TOTAL_AMOUNT, 0)) - SUM(DISTINCT NVL(AVAILED, 0)) AS BALANCE,
        --  NVL( SUM(FS.AVAILED),0) BALANCE,
          FS.FACILITIES_ID
    FROM
           FINAL_SUM FS
  
    GROUP BY
           FS.BANK_ID ,
           FS.FACILITIES_ID
           )
    SELECT
             LU.BANK_ID,
             LU.BANK_NAME,
             COUNT(*) OVER (PARTITION BY LU.BANK_NAME) AS BANK_ROWSPAN,
             COUNT(*) OVER (PARTITION BY LU.BANK_NAME, FACILITIES_NAME) AS  FACILITIES_ROWSPAN,
             COUNT(*) OVER (PARTITION BY LU.BANK_NAME, FACILITIES_NAME , TOTAL_AMOUNT) AS AMOUNT_ROWSPAN,
             COUNT(*) OVER (PARTITION BY LU.BANK_NAME, FACILITIES_NAME , TOTAL_AMOUNT,BA.BALANCE) AS BALANCE_ROWSPAN,
             TOTAL_AMOUNT,
             COMPANY_NAME,
             ACCOUNT_NO,
             FACILITIES_NAME,
          
             AVAILED,
             BA.BALANCE
            --  LU.MATURITY,
            --  LU.TOMORROW,
            --  LU.DAY_AFTER_TOMORROW,
            --  LU.OVER_DUE,
            --  LU.FACILITIES_ID
    FROM
                        FINAL_SUM LU 
     LEFT JOIN  BALANCE_AMOUNT BA ON BA.FACILITIES_ID=LU.FACILITIES_ID
 ) LOOP
    
    htp.p('<tr>');
    
    IF PREV_BANK_NAME IS NULL OR x.BANK_NAME <> PREV_BANK_NAME THEN
      htp.p('<td rowspan="'||x.BANK_ROWSPAN||'">'||htf.escape_sc(x.BANK_NAME)||'</td>');
    END IF;
        htp.p('<td>'||NVL(htf.escape_sc(x.COMPANY_NAME), '0')||'</td>');
    htp.p('<td>'||NVL(htf.escape_sc(x.ACCOUNT_NO), '0')||'</td>');


     IF PREV_FACILITIES_NAME IS NULL OR x.FACILITIES_NAME <> PREV_FACILITIES_NAME THEN
      htp.p('<td rowspan="'||x.FACILITIES_ROWSPAN||'">'||htf.escape_sc(x.FACILITIES_NAME)||'</td>');
    END IF;
    
    
     IF PREV_TOTAL_AMOUNT IS NULL OR x.TOTAL_AMOUNT <> PREV_TOTAL_AMOUNT THEN
      htp.p('<td rowspan="'||x.AMOUNT_ROWSPAN||'">'||htf.escape_sc(x.TOTAL_AMOUNT)||'</td>');
    END IF;
    
    htp.p('<td>'||NVL(htf.escape_sc(x.AVAILED), '0')||'</td>');
      IF PREV_BALANCE IS NULL OR x.BALANCE <> PREV_BALANCE THEN
      htp.p('<td rowspan="'||x.BALANCE_ROWSPAN||'">'||htf.escape_sc(x.BALANCE)||'</td>');
    END IF;
   
    -- htp.p('<td>'||NVL(htf.escape_sc(x.MATURITY), '0')||'</td>');
    -- htp.p('<td>'||NVL(htf.escape_sc(x.TOMORROW), '0')||'</td>');
    -- htp.p('<td>'||NVL(htf.escape_sc(x.DAY_AFTER_TOMORROW), '0')||'</td>');
    -- htp.p('<td>'||NVL(htf.escape_sc(x.OVER_DUE), '0')||'</td>');
    htp.p('</tr>');
    
    PREV_BANK_NAME := x.BANK_NAME;
    PREV_FACILITIES_NAME := x.FACILITIES_NAME;
    PREV_TOTAL_AMOUNT := x.TOTAL_AMOUNT;
    PREV_BALANCE := x.BALANCE;
  END LOOP;  
END;
  

htp.p('</body>');htp.p('</html>');END;
